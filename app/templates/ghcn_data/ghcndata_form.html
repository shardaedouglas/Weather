{% extends "base.html" %}
{% block title %}View GHCN Daily Data{% endblock %}
{% block content %}

<div class="container-md">
    <div class="row g-3">
        <div class="col g-3">
            <p style="font-size: 260%; font-weight: bold;">View Daily Data</p>
            <p>This is a brief description.</p>
        </div>
    </div>
 

<div class="container-md form-container" >
    <form class="row g-3 align-items-center">
        <div class="row g-3">
            <div class="col-md input-group">
                <input class="form-check-input id-option-ghcn" type="radio" id="radio-option-ghcn-id" name="id-option" value="GHCN ID" checked="checked" >
                <span class="input-group-text" id="inputGroup-sizing-default">GHCN ID</span> {{ghcnForm.ghcn_id(class_='form-control', id='search-option-ghcn-id')}}
            </div>
            
            <div class="col-md input-group" style="flex-wrap: nowrap;">
                <input class="form-check-input id-option-ghcn" type="radio" id="radio-option-country" name="id-option" value="Country">
                <span class="input-group-text" id="inputGroup-sizing-default">Country</span> 
                <span class="tt" title="Country Input">{{ghcnForm.country(class_='form-select country-select', id='search-option-country')}}</span>
            </div>
            
            <div class="col-md input-group" style="flex-wrap: nowrap;">
                <input class="form-check-input id-option-ghcn" type="radio" id="radio-option-state" name="id-option" value="State">
                <span class="input-group-text" id="inputGroup-sizing-small">State</span> {{ghcnForm.state(class_='form-select state-select', id='search-option-state')}}
            </div>
        </div>
        <div class="row g-3" style="padding-top: 15px; padding-bottom: 15px;">
            <div class="col-md input-group" style="flex-wrap: nowrap;">
                <span class="input-group-text" id="inputGroup-sizing-default">Type</span>
                {{ghcnForm.station_type(class_='form-select type-select')}}
            </div>
            <div class="col-md input-group" id="date-div">
                <span class="input-group-text" id="inputGroup-sizing-default" >Date</span>
                {{ghcnForm.date(class_='form-control date-picker')}}
            </div>
        </div>

        <div class="row justify-content-center" id="button-row">
            <div class="col-md">
                <button type="reset" class="btn button-dull" onclick="hideGHCNViewTable()" style="width:100%;display:block;font-weight: bold">Clear</button>
            </div>
            <div class="col-md">
                <button type="submit" class="btn btn-success" style="width:100%;display:block;font-weight: bold">Submit</button>
            </div>
            
        </div>
    </form>
</div>

<div id="spinner" class="spinner-border text-info" style="display:none; margin-left: auto; margin-right: auto; margin-top: 20px;" >
</div>

<div id="station-data-view" style="display:none;">
    {% include "ghcn_data/ghcn_station_data.html" %}
</div>

</div>  

<script>
    
    document.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);
        console.log("urlParams", urlParams);
        if (urlParams.size > 0) {
            
            const loadingWheel = document.querySelector('#spinner');
            loadingWheel.style.display = 'block';

            let queryStringData = getDataFromURL(urlParams);
            document.getElementById("station-data-view").style.display = "block";

            loadingWheel.style.display = 'none';

        }        
    });
    
    function hideGHCNViewTable() {
       document.getElementById('station-data-view').style.display = "none";
    }

    $(document).ready(function() {

        // Disables other radio options when one is selected.
        function enableSelectedForm() {
            if ($("#radio-option-ghcn-id").is(":checked")) {
                $("#search-option-ghcn-id").removeAttr('disabled');
                $("#search-option-country").attr('disabled', true);
                $("#search-option-state").attr('disabled', true);


            } else if ($("#radio-option-country").is(":checked")) {
                $("#search-option-ghcn-id").attr('disabled', true);
                $("#search-option-country").removeAttr('disabled');
                $("#search-option-state").attr('disabled', true);


            } else if ($("#radio-option-state").is(":checked")) {
                $("#search-option-ghcn-id").attr('disabled', true);
                $("#search-option-country").attr('disabled', true);
                $("#search-option-state").removeAttr('disabled');


            }

        }
    
        // Initialize radio button disabling
        enableSelectedForm();
    
        // Handle radio button clicks to show the corresponding form
        $("input[name='id-option']").click(function() {
            enableSelectedForm();
        });
    })

    //Form Submission and Show data table
    // $(document).ready(function () {
    //     $("form").submit(function (event) {
    //         event.preventDefault(); // Prevent the default form submission
    //         var formData = $(this).serialize(); //Retrieve the form data
    //         // Send the request to handle the form data. async?
    //         // Once data is returned, show the populated data table.
    //         showGHCNViewTable();
    //     })

    // });

    // function showComparisonTable(data) {
    //     const tableBody = document.querySelector("#station-data-view tbody");
    //     tableBody.innerHTML = ""; // Clear existing rows
    
    //     // Sort the days numerically
    //     const sortedDays = Object.keys(data).sort((a, b) => parseInt(a.replace('Day ', '')) - parseInt(b.replace('Day ', '')));

    //     sortedDays.forEach(dayKey => {
    //         const dayData = data[dayKey];
    //         const row = `
    //             <tr>
    //                 <td>${dayKey}</td>
    //                 <td>${dayData.TMAX || ""}</td>
    //                 <td>${dayData.TMIN || ""}</td>
    //                 <td>${dayData.TOBS || ""}</td>
    //                 <td>${dayData.PRCP || ""}</td>
    //                 <td>${dayData.SNOW || ""}</td>
    //                 <td>${dayData.SNWD || ""}</td>
    //                 <td>${dayData.WTXX || ""}</td>
    //             </tr>
    //         `;
    //         tableBody.insertAdjacentHTML('beforeend', row);
    //     });

    //     document.getElementById("station-data-view").style.display = "block";
    // }



    function showComparisonTable(data) {
        const table = document.getElementById("station-data-view");
        const thead = table.querySelector("thead");
        const tbody = table.querySelector("tbody");
        tbody.innerHTML = ""; // clear old rows
        thead.innerHTML = ""; // clear old headers

        // Sort days numerically
        const sortedDays = Object.keys(data).sort((a, b) => parseInt(a.replace('Day ', '')) - parseInt(b.replace('Day ', '')));

        // Collect all unique keys from data (except day label)
        const allKeysSet = new Set();
        sortedDays.forEach(dayKey => {
            Object.keys(data[dayKey]).forEach(k => allKeysSet.add(k));
        });

        // Convert to array and sort keys alphabetically or keep custom order
        const allKeys = Array.from(allKeysSet).sort();

        // Build table header row dynamically
        let headerRow = `<tr><th>Day</th>`;
        allKeys.forEach(key => {
            headerRow += `<th>${key}</th>`;
        });
        headerRow += `</tr>`;
        thead.insertAdjacentHTML('beforeend', headerRow);

        // Build table rows dynamically
        sortedDays.forEach(dayKey => {
            const dayData = data[dayKey];
            let row = `<tr><td>${dayKey}</td>`;
            allKeys.forEach(key => {
                row += `<td>${dayData[key] !== undefined ? dayData[key] : ""}</td>`;
            });
            row += `</tr>`;
            tbody.insertAdjacentHTML('beforeend', row);
        });

        table.style.display = "block";
    }

    function getDataFromURL(urlParams) {
            // Extract the query parameters
            const idOption = urlParams.get('id-option');
        
            if (idOption === 'State') {
                // If the id-option is "State", use state-based parameters
                const state = urlParams.get('state');
                const stationType = urlParams.get('station_type');
                const date = urlParams.get('date');
        
                var requestData = {
                    state: state,
                    date: date,
                    station_type: stationType,
                };
        
                // Send the state-based request
                $.ajax({
                    url: '/get_state_for_GHCN_table_df',
                    method: 'POST',
                    data: $.param(requestData),
                    success: function(response) {
                        console.log("Success:", response);
                        showComparisonTable(response);
                    },
                    error: function(xhr, status, error) {
                        console.error("Error:", error);
                        alert("There was an error processing your request.");
                    }
                });
        
            } else {
                // Default behavior using GHCN ID
                const ghcnId = urlParams.get('ghcn_id');
                const stationType = urlParams.get('station_type');
                const date = urlParams.get('date');
        
                var requestData = {
                    ghcn_id: ghcnId,
                    date: date,
                    station_type: stationType
                };
        
                // Send the request
                $.ajax({
                    url: '/get_data_for_GHCN_table',
                    method: 'POST',
                    data: $.param(requestData),
                    success: function(response) {
                        console.log("Success:", response);
                        showComparisonTable(response);
                    },
                    error: function(xhr, status, error) {
                        console.error("Error:", error);
                        alert("There was an error processing your request.");
                    }
                });

                // TEST Request for debugging
                $.ajax({
                    url: '/get_station_calc_for_GHCND',
                    method: 'POST',
                    data: $.param(requestData),
                    success: function(response) {
                        console.log("Success:", response);
                        showGHCNDCalculations(response)
                        // showComparisonTable(response);
                        // console.log(response);
                    },
                    error: function(xhr, status, error) {
                        console.error("Error:", error);
                        alert("There was an error processing your request.");
                    }
                });
            }
        }
        
        function showGHCNDCalculations(data) {

            // Temperature
            $(".ghcnd-calc-av-max").text(data["AvMax"] !== null ? data["AvMax"]  : "N/A");
            $(".ghcnd-calc-av-min").text(data["AvMin"] !== null ? data["AvMin"]  : "N/A");
            $(".ghcnd-calc-av-temp").text(data["AvTmp"] !== null ? data["AvTmp"]  : "N/A");
            $(".ghcnd-calc-max-temp").text(data.MaxTp["MaxTp"] !== null ? data.MaxTp["MaxTp"]  : "N/A");
            $(".ghcnd-calc-max-temp-date").text(data.MaxTp["Day"] !== null ? data.MaxTp["Day"]  : "N/A");
            $(".ghcnd-calc-min-temp").text(data.MinTp["MinTp"]  !== null ? data.MinTp["MinTp"]  : "N/A");
            $(".ghcnd-calc-min-temp-date").text(data.MinTp["Day"] !== null ? data.MinTp["Day"] : "N/A" );

            // Precipitation and Snowfall
            $(".ghcnd-calc-totpcn").text(data["TotPcn"] !== null ? data["TotPcn"] : "N/A");
            $(".ghcnd-calc-snow").text(data["Snow"] !== null ? data["Snow"] : "N/A");
            $(".ghcnd-calc-snow-depth").text(data["S Depth"] !== null ? data["S Depth"] : "N/A");
            $(".ghcnd-calc-hdd").text(data["HDD"] !== null ? data["HDD"] : "N/A");
            $(".ghcnd-calc-cdd").text(data["CDD "] !== null ? data["CDD "] : "N/A"); // Note: "CDD " has a trailing space in your data object key

            // Max 24-Hour Precipitation
            $(".ghcnd-calc-max-24hr").text(data.Max24Hr && data.Max24Hr["Max24Hr"] !== null ? data.Max24Hr["Max24Hr"] : "N/A");
            $(".ghcnd-calc-max-24hr-date").text(data.Max24Hr && data.Max24Hr["Day"] !== null ? data.Max24Hr["Day"] : "N/A");

            // Number of Days  Precipitation Thresholds
            $(".ghcnd-calc-pcn-gt01").text(data["NOD Pcn"] && data["NOD Pcn"][">.01"] !== null ? data["NOD Pcn"][">.01"] : "N/A");
            $(".ghcnd-calc-pcn-gt10").text(data["NOD Pcn"] && data["NOD Pcn"][">.10"] !== null ? data["NOD Pcn"][">.10"] : "N/A");
            $(".ghcnd-calc-pcn-gt100").text(data["NOD Pcn"] && data["NOD Pcn"][">1"] !== null ? data["NOD Pcn"][">1"] : "N/A");

            // Number of Days with Snowfall >= one inch
            $(".ghcnd-calc-sf-gt100").text(data["SF>1="] !== null ? data["SF>1="] : "N/A");

            // Number of Days Temperature Thresholds
            $(".ghcnd-calc-max-temp-gt90").text(data["NOD Tmp"] && data["NOD Tmp"]["MxT>=90"] !== null ? data["NOD Tmp"]["MxT>=90"] : "N/A");
            $(".ghcnd-calc-max-temp-lt32").text(data["NOD Tmp"] && data["NOD Tmp"]["MxT<=32"] !== null ? data["NOD Tmp"]["MxT<=32"] : "N/A");
            $(".ghcnd-calc-min-temp-lt0").text(data["NOD Tmp"] && data["NOD Tmp"]["MnT<=0"] !== null ? data["NOD Tmp"]["MnT<=0"] : "N/A");

            // Number of Days with Snow Depth >= (one inch???) - based on your comment, assuming this maps to "SD>="
            $(".ghcnd-calc-snow-depth-gt100").text(data["SD>="] !== null ? data["SD>="] : "N/A");

        }

    </script>

{% endblock content %}