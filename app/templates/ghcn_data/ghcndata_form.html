{% extends "base.html" %}
{% block title %}View GHCN Daily Data{% endblock %}
{% block content %}

<div class="container-md">
    <div class="row g-3">
        <div class="col g-3">
            <p style="font-size: 260%; font-weight: bold;">View GHCN Data</p>
            <p>This is a brief description.</p>
        </div>
    </div>
 

<div class="container-md form-container" >
    <form class="row g-3 align-items-center">
        <div class="row g-3">
            <div class="col-md input-group">
                <input class="form-check-input id-option-ghcn" type="radio" id="radio-option-ghcn-id" name="id-option" value="GHCN ID" checked="checked" >
                <span class="input-group-text" id="inputGroup-sizing-default">GHCN ID</span> {{ghcnForm.ghcn_id(class_='form-control', id='search-option-ghcn-id')}}
            </div>
            
            <!--<div class="col-md input-group" style="flex-wrap: nowrap;">
                <input class="form-check-input id-option-ghcn" type="radio" id="radio-option-country" name="id-option" value="Country">
                <span class="input-group-text" id="inputGroup-sizing-default">Country</span> 
                <span class="tt" title="Country Input">{{ghcnForm.country(class_='form-select country-select', id='search-option-country')}}</span>
            </div>
            
            <div class="col-md input-group" style="flex-wrap: nowrap;">
                <input class="form-check-input id-option-ghcn" type="radio" id="radio-option-state" name="id-option" value="State">
                <span class="input-group-text" id="inputGroup-sizing-small">State</span> {{ghcnForm.state(class_='form-select state-select', id='search-option-state')}}
            </div>
        </div>
        <div class="row g-3" style="padding-top: 15px; padding-bottom: 15px;">
            -->
            
            <div class="col-md input-group" style="flex-wrap: nowrap;">
                <span class="input-group-text" id="inputGroup-sizing-default">Type</span>
                {{ghcnForm.station_type(class_='form-select type-select')}}
            </div>
            <div class="col-md input-group" id="date-div">
                <!-- Date Picker Modal -->
                    <div id="date-picker-modal" class="modal fade" tabindex="-1" aria-labelledby="date-picker-modal-label" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="date-picker-modal-label">Select Date</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="container-fluid">
                                        <div class="row g-4">
                                            <!-- Year Column -->
                                            <div class="col">
                                                <h3 class="fw-bold text-dark mb-2">Year</h3>
                                                <div id="year-list" class="list-group list-group-flush" style="overflow-y: auto; max-height: 450px;">
                                                    <!-- Years will be dynamically generated here -->
                                                </div>
                                            </div>
                                            <!-- Month Column -->
                                            <div class="col">
                                                <h3 class="fw-bold text-dark mb-2">Month</h3>
                                                <div id="month-list" class="list-group list-group-flush" style="overflow-y: auto; max-height: 450px;">
                                                    <!-- Months will be dynamically generated here -->
                                                </div>
                                            </div>
                                            
                                        </div>
                                    </div>
                                </div>
                                <!-- Footer Buttons -->
                                <div class="modal-footer justify-content-end">
                                    <button id="cancel-btn" type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                        Close
                                    </button>
                                    <button id="ok-btn" type="button" class="btn btn-primary" data-bs-dismiss="modal">
                                        Ok
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Correct structure for Bootstrap input-group -->
                    <div class="input-group">
                        <label for="date" class="input-group-text">Date</label>
                        <input type="text" name='date' class="form-control" id="date" placeholder="yyyymm" data-bs-toggle="modal" data-bs-target="#date-picker-modal">
                    </div>
                    <!-- <span class="input-group-text" id="inputGroup-sizing-default" >Date</span>
                {{ghcnForm.date(class_='form-control date-picker')}} -->
            </div>
        </div>

        <div class="row justify-content-center" id="button-row">
            <div class="col-md">
                <!-- <button type="reset" class="btn button-dull w-100 d-block fw-bold" onclick="hideGHCNViewTable()">Clear</button> -->
                <button type="reset" class="btn button-dull w-100 d-block fw-bold">Clear</button>
            </div>
            <div class="col-md">
                <button type="submit" class="btn btn-success w-100 d-block fw-bold">Submit</button>
            </div>
            
        </div>
    </form>
</div>

<div id="spinner" class="spinner-border text-info" style="display:none; margin-left: auto; margin-right: auto; margin-top: 20px;" >
</div>

<div id="station-data-view" style="display: none;">
    {% include "ghcn_data/ghcn_station_data.html" %}
</div>

<div id="station-metadata-view" style="display: none;">
    <!-- {% if station_data %} -->
        <!-- {% include "ghcn_data/station_metadata.html" %} -->
    <!-- {% endif %} -->
</div>

<div id="station-inventory-view" style="display: none;">

        {% include "ghcn_data/station_inventory_view.html" %}

</div>


</div>  

<script>
    // Provides context to allow the save button to capture the current state of the table
    let lastFetchedData = null;
    // Variable holding the table's current display option. 
    let selectedDisplayGroup = 1;

    // Spinner Buffering Animation Control
    document.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);
        console.log("urlParams", urlParams);
        if (urlParams.size > 0) {

            /**
             * Synchronizes form input fields with URL parameters.
             *
             * This function reads URL query parameters and uses them to set the values of
             * corresponding form input fields.
             * This is useful for pre-populating the GHCND form based on a user's previous
             * selections or a shared URL.
             *
             * @param {URLSearchParams} urlParams - An instance of the URLSearchParams
             * object containing the URL's query parameters.
             * @returns {void}
             */
            function populateInputsFromUrl(urlParams) { 

                if (urlParams.has("id-option")) {
                    switch (urlParams.get("id-option")){
                        case "State": 
                            $("#radio-option-state").prop("checked", true);
                            
                            break;
                        case "Country": 
                            $("#radio-option-country").prop("checked", true);
                            
                            break;
                        case "GHCN ID": 
                            $("#radio-option-ghcn-id").prop("checked", true);
                            break;
                    }
                };
                if (urlParams.has("state")) { 
                    $('#search-option-state').val(urlParams.get("state") );

                }
                if (urlParams.has("country")) { 
                    $('#search-option-country').val(urlParams.get("country") );

                }
                if (urlParams.has("ghcn_id")) { 
                    $('#search-option-ghcn-id').val(urlParams.get("ghcn_id") );

                }
                if (urlParams.has("station_type")) { 
                    $('#station_type').val(urlParams.get("station_type") );

                }
                if (urlParams.has("date")) { 
                    $('#date').val(urlParams.get("date") );

                }

            };
            
            populateInputsFromUrl(urlParams);
            const loadingWheel = document.querySelector('#spinner');
            loadingWheel.style.display = 'block';

            let queryStringData = getDataFromURL(urlParams);
            document.getElementById("station-data-view").style.display = "block";

            loadingWheel.style.display = 'none';

        }        
    });

    // Clear button logic
    $("button[type='reset']").on("click", function() {
        $("#station-data-view").hide();
        $("#station-metadata-view").hide();
        $("#station-inventory-view").hide();
    });
    
    // The Station Identifier Logic for form 1
    $(document).ready(function() {

        // Disables other radio options when one is selected.
        function enableSelectedForm() {
            if ($("#radio-option-ghcn-id").is(":checked")) {
                $("#search-option-ghcn-id").removeAttr('disabled');
                $("#search-option-country").attr('disabled', true);
                $("#search-option-state").attr('disabled', true);


            } else if ($("#radio-option-country").is(":checked")) {
                $("#search-option-ghcn-id").attr('disabled', true);
                $("#search-option-country").removeAttr('disabled');
                $("#search-option-state").attr('disabled', true);


            } else if ($("#radio-option-state").is(":checked")) {
                $("#search-option-ghcn-id").attr('disabled', true);
                $("#search-option-country").attr('disabled', true);
                $("#search-option-state").removeAttr('disabled');


            }

        }
    
        // Initialize radio button disabling
        enableSelectedForm();
    
        // Handle radio button clicks to show the corresponding form
        $("input[name='id-option']").click(function() {
            enableSelectedForm();
        });
    }) 

    

    

    // Gets the data from the intial form to begin populating the tables and dropdowns with data
    function getDataFromURL(urlParams) {
        const idOption = urlParams.get('id-option');
        const date = urlParams.get('date');
        const stationType = urlParams.get('station_type');

        if (idOption === 'State') {
            const state = urlParams.get('state');

            const requestData = {
                state: state,
                date: date,
                station_type: stationType,
            };

            $.ajax({
                url: '/get_state_for_GHCN_table_df',
                method: 'POST',
                data: $.param(requestData),
                success: function(response) {
                    console.log("RESPONSE.DATA = ", response.data)
                    lastFetchedData = response.data;
                    // ghcnID = "USC00049026"
                    console.log("lastFetchedData = ", lastFetchedData)
                    console.log("response keys 4:", Object.keys(response));
                    console.log("orderedKeys 4:", response.orderedKeys);
                    showComparisonTable(response, response.ordered_keys);
                    populateYearDropdown(response);
                    fetchAndRenderStationMetadata(ghcnId);
                },
                error: function(xhr, status, error) {
                    console.error("Error:", error);
                    handleAjaxError(xhr, status, error, "There was an error processing your data request.");
                }
            });


    
        } else {
            const ghcnId = urlParams.get('ghcn_id');
            const unitMode = document.getElementById("unit-selector").value;

            const requestData = {
                ghcn_id: ghcnId,
                date: date,
                station_type: stationType,
                unit_mode: unitMode,
                display_group: selectedDisplayGroup || 1

            };

            $.ajax({
                url: '/get_data_for_GHCN_table',
                method: 'POST',
                data: $.param(requestData),
                success: function(response) {

                    console.log("RESPONSE.DATA = ", response.data)                       
                    lastFetchedData = response.data;
                    console.log("lastFetchedData = ", lastFetchedData)    
                    console.log("response keys 5:", Object.keys(response));
                    console.log("orderedKeys 5:", response.orderedKeys);                   
                    showComparisonTable(response.data, response.ordered_keys);
                    populateYearDropdown(response);
                    fetchAndRenderStationMetadata(ghcnId);

                },
                error: function(xhr, status, error) {
                    console.error("Error:", error);
                    handleAjaxError(xhr, status, error, "There was an error processing your data request.");
                }
            });

            $.ajax({
                url: '/get_station_calc_for_GHCND',
                method: 'POST',
                data: $.param(requestData),
                success: function(response) {
                    console.log("Success:", response);
                    showGHCNDCalculations(response)
                    // showComparisonTable(response);
                    // console.log(response);
                },
                error: function(xhr, status, error) {
                    console.error("Error:", error);
                    handleAjaxError(xhr, status, error, "There was an error processing your data request.");
                }
            });
        }
    }
        

    function showComparisonTable(data, orderedKeys) {
        $("#GHCND_Table").empty();
        if (data === "EMPTY") {
            // alert("empty table");
            $( "#GHCND_Table" ).text( "No data available for the station." );
            return
        }
        lastFetchedData = data;
        console.log("data", data);
        console.log("orderedKeys", orderedKeys);
        
        // Add leading 0 to days < 10
        const paddedData = {};
        for (const key in data) {
        const dayNumber = key.replace('Day ', '');
        const paddedNumber = dayNumber.padStart(2, '0');
        const newKey = `Day ${paddedNumber}`;
        paddedData[newKey] = data[key];
        }
        data = paddedData;

        // Sort days numerically
        const sortedDays = Object.keys(data).sort(
            (a, b) => parseInt(a.replace('Day ', '')) - parseInt(b.replace('Day ', ''))
        );

        // Use orderedKeys from backend or fallback to keys from data
        const allKeys = orderedKeys && orderedKeys.length > 0
            ? orderedKeys
            : (() => {
                const keysSet = new Set();
                sortedDays.forEach(dayKey => {
                    Object.keys(data[dayKey]).forEach(k => keysSet.add(k));
                });
                return Array.from(keysSet).sort();
            })();
        
        
        // Reformat the data object for DataTables()
        const reformattedData = [];

        for (const dayKey of sortedDays) {
            if (data.hasOwnProperty(dayKey)) {
                const dayData = data[dayKey];
                
                const newObject = {
                    Day: dayKey,
                };
                
                Object.assign(newObject, dayData);
                
                reformattedData.push(newObject);
            }
        }

        // console.log("reformattedData:", reformattedData);

        columns = [ {data: "Day", title: "Day", name: "Day"} ];
        for (key of orderedKeys) {
            columns.push(
                { data: key, title: key, name: key },
            )
        }

        // console.log("COLUMNS:", columns);

        if ($.fn.DataTable.isDataTable('#GHCND_Table')) {
            console.log("Table exists. Deleting.")
            $("#GHCND_Table")
                .DataTable()
                .destroy();
            $("#GHCND_Table").empty();
        }

        $('#GHCND_Table').dataTable({
            pageLength: 50,
            // destroy: true,
            data: reformattedData,
            columns: columns
        });


        // Attach save button event handler fresh to avoid duplicates
        const saveBtn = document.getElementById("save-button");
        if (saveBtn) {
            const newSaveBtn = saveBtn.cloneNode(true);
            saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

            newSaveBtn.addEventListener("click", function () {
                if (!lastFetchedData || Object.keys(lastFetchedData).length === 0) {
                    errorPopup.warning("No data available to save.");
                    return;
                }
                downloadCSVFromJSON(lastFetchedData, "GHCN_data_export.csv");
            });
        }
        return
    };
    

    // **** Change Year Logic **** \\
    // Get the years associated with the target station
    function populateYearDropdown(response) {
        const yearDropdown = document.getElementById("year-selector");
        yearDropdown.innerHTML = '<option selected>--Select--</option>';

        if (response.years && Array.isArray(response.years)) {
            response.years.forEach(yr => {
                const opt = document.createElement("option");
                opt.value = yr;
                opt.textContent = yr;
                yearDropdown.appendChild(opt);
            });
        } else {
            const placeholderYears = [2021, 2022, 2023];
            placeholderYears.forEach(yr => {
                const opt = document.createElement("option");
                opt.value = yr;
                opt.textContent = yr;
                yearDropdown.appendChild(opt);
            });
        }
    }
    
    // Update data table when the year is changed
    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("year-selector").addEventListener("change", function () {
            const selectedYear = this.value;
            console.log("Selected Year:", selectedYear)
            // Check if year has changed then grab the data for the new year selected
            if (selectedYear && selectedYear !== "--Select--") {
                const ghcnId = new URLSearchParams(window.location.search).get("ghcn_id");
                const stationType = new URLSearchParams(window.location.search).get("station_type");
                const date = new URLSearchParams(window.location.search).get("date");
                //const month = new URLSearchParams(window.location.search).get("date").substring(4);
                month = date.substring(4,6)
                console.log(month)
                // Fake a correction_date using just year + dummy month/day
                const correctionDate = `${selectedYear}${month}`; 

                    $.ajax({
                        url: '/get_data_for_GHCN_table',
                        method: 'POST',
                        data: $.param({
                            ghcn_id: ghcnId,
                            date: correctionDate,
                            station_type: stationType,
                            display_group: "1"
                        }),
                        success: function (response) {
                            console.log("RESPONSE.DATA = ", response.data);
                            console.log("RESPONSE = ", response);
                            lastFetchedData = response.data;
                            console.log("lastFetchedData = ", lastFetchedData)
                            console.log("response keys 1:", Object.keys(response));
                            console.log("ordered_keys 1:", response.ordered_keys);
                            showComparisonTable(response.data, response.ordered_keys);
                            fetchAndRenderStationMetadata(ghcnId);
                            $.ajax({
                                url: '/get_station_calc_for_GHCND',
                                method: 'POST',
                                data: $.param({
                                        ghcn_id: ghcnId,
                                        date: correctionDate,
                                        station_type: stationType
                                    }),
                                success: function(response) {
                                    console.log("Success:", response);
                                    showGHCNDCalculations(response)
                                    console.log("New station calculations");
                                    // showComparisonTable(response);
                                    // console.log(response);
                                },
                                error: function(xhr, status, error) {
                                    console.error("Error:", error);
                                    handleAjaxError(xhr, status, error, "There was an error processing your data request.");
                                }
                            });
                        },
                        error: function (xhr, status, error) {
                            console.error("Error reloading year:", error);
                                    handleAjaxError(xhr, status, error, "Could not load data for the selected year.");
                        }
                    });
                }
            });
            
        });

    
    // **** Split Month functionality **** \\
    $(document).ready(function(){
        $('#flexCheckDefault').click(function(){
            if($(this).prop("checked") == true){
                console.log("Initiate Split Month")

                //Get Date Current Date and Station
                const urlParams = new URLSearchParams(window.location.search);
                const ghcnId = urlParams.get("ghcn_id");
                const stationType = urlParams.get("station_type");
                var date = urlParams.get("date");
                var newDate = '';
                prevMonth = '';
                month = date.substring(4,6)
                year = date.substring(0,4)
                // Parse Date to get the previous month
                if (month === '01'){
                    prevMonth = '12';
                    year = parseInt(year) - 1
                    newDate = year.toString() + prevMonth
                }
                else{
                    prevMonth = parseInt(month) - 1;
                    newDate = year + prevMonth.toString()
                }
                

                //Get the current state of the data table
                const context = lastFetchedData;
                console.log('Last Month\'s data..Context:', context)
                
                //Get the current selected units ***May not need this line
                const unitMode = document.getElementById("unit-selector").value;

                // Get the data for the Previous Month 
                $.ajax({
                    url: '/get_data_for_GHCN_table',
                    method: 'POST',
                    data: $.param({
                        ghcn_id: ghcnId,
                        date: newDate,
                        station_type: stationType,
                        unit_mode: unitMode,
                        display_group: selectedDisplayGroup
                    }),
                    success: function (response) {
                        console.log("RESPONSE.DATA = ", response.data)
                        console.log("The table Keys:", response.ordered_keys) 

                        //Combine both month's data
                        let split_month_data = {};
                        
                        //const entries = Object.entries(response.data);

                        for (i=1; i <= 15; i++) {
                            split_month_data['Day ' + i] = response.data['Day ' + i]
                            
                        }
                        
                        for (i=16; i <=31; i++){
                            split_month_data['Day ' + i] = context['Day ' + i]
                        }
                        console.log('split month data', split_month_data)
                        //Populate Table with previous month's data
                        showComparisonTable(split_month_data, response.ordered_keys)
                    },
                    error: function (xhr, status, error) {
                        console.error("Error reloading year:", error);
                        handleAjaxError(xhr, status, error, "Could not load data for the selected year.");
                    }
                })

                

            }
            else if($(this).prop("checked") == false){
                console.log("Disable Split Month")
                // Reset to the original table data
            }
        })
    })



    // **** Unit Conversion Logic **** \\
    document.addEventListener("DOMContentLoaded", function () {
        const unitSelector = document.getElementById("unit-selector");
        
        unitSelector.addEventListener("change", function () {
            const unitMode = this.value;
            const urlParams = new URLSearchParams(window.location.search);
            const ghcnId = urlParams.get("ghcn_id");
            const stationType = urlParams.get("station_type");
            const date = urlParams.get("date");

            console.log("unitMode:", unitMode);
            console.log("ghcn_id from URL:", ghcnId);
            console.log("station_type from URL:", stationType);
            console.log("date from URL:", date);


            if (ghcnId && stationType && date && unitMode) {
                $.ajax({
                    url: '/get_data_for_GHCN_table',
                    method: 'POST',
                    data: $.param({
                        ghcn_id: ghcnId,
                        date: date,
                        station_type: stationType,
                        unit_mode: unitMode,
                        display_group: selectedDisplayGroup
                    }),
                    success: function (response) {
                        console.log("RESPONSE.DATA = ", response.data)

                        lastFetchedData = response.data;
                        console.log("lastFetchedData = ", lastFetchedData)
                        console.log("response keys 2:", Object.keys(response));
                        console.log("orderedKeys 2:", response.orderedKeys);
                        showComparisonTable(response.data, response.ordered_keys);
                        fetchAndRenderStationMetadata(ghcnId);


                    },
                    error: function (xhr, status, error) {
                        console.error("Unit change error:", error);
                        handleAjaxError(xhr, status, error, "Failed to reload data with selected units.");
                    }
                });
            }
        });
    });

    // **** Change Display Logic **** \\
    document.addEventListener("DOMContentLoaded", function () {
        const displaySelector = document.getElementById("display-selector");

        displaySelector.addEventListener("change", function () {
            selectedDisplayGroup = this.value;
            const urlParams = new URLSearchParams(window.location.search);
            const ghcnId = urlParams.get("ghcn_id");
            const stationType = urlParams.get("station_type");
            const date = urlParams.get("date");
            const unitMode = document.getElementById("unit-selector").value;
            console.log("selectedDisplayGroup:", selectedDisplayGroup);

            
            if (ghcnId && stationType && date && selectedDisplayGroup) {
                $.ajax({
                    url: '/get_data_for_GHCN_table',
                    method: 'POST',
                    data: $.param({
                        ghcn_id: ghcnId,
                        date: date,
                        station_type: stationType,
                        unit_mode: unitMode,
                        display_group: selectedDisplayGroup
                    }),
                    success: function (response) {
                        console.log("RESPONSE.DATA = ", response.data)
                        lastFetchedData = response.data;
                        // ghcnID = "USC00049026"
                        console.log("lastFetchedData = ", lastFetchedData)
                        console.log("response keys 3 :", Object.keys(response));
                        console.log("orderedKeys 3:", response.orderedKeys);
                        showComparisonTable(response.data, response.ordered_keys);
                        fetchAndRenderStationMetadata(ghcnId);

                    },
                    error: function (xhr, status, error) {
                        console.error("Display group change error:", error);
                        handleAjaxError(xhr, status, error, "Failed to reload data with selected display group.");
                    }
                });
            }
        });
    });

    
    
    /** GHCN Calculation Logic
     * Populates a data table with GHCND (Global Historical Climatology Network Daily) calculations.
     *
     * This function takes a structured data object containing various calculated
     * meteorological statistics and uses it to populate an HTML element.
     *
     * @param {object} data - An object containing calculated GHCND statistics for display.
     * @param {number} data.AvMax - The average maximum temperature.
     * @param {number} data.AvMin - The average minimum temperature.
     * @param {number} data.AvTmp - The overall average temperature.
     * @param {object} data.MaxTp - Details for the highest temperature recorded.
     * @param {number} data.MaxTp.MaxTp - The maximum temperature value.
     * @param {string} data.MaxTp.Day - The date (e.g., 'YYYY-MM-DD') when the maximum temperature occurred.
     * @param {object} data.MinTp - Details for the lowest temperature recorded.
     * @param {number} data.MinTp.MinTp - The minimum temperature value.
     * @param {string} data.MinTp.Day - The date (e.g., 'YYYY-MM-DD') when the minimum temperature occurred.
     * @param {object} data.Max24Hr - Details for the maximum 24-hour precipitation.
     * @param {number} data.Max24Hr.Max24Hr - The maximum 24-hour precipitation value.
     * @param {string} data.Max24Hr.Day - The day (e.g., 'DD') when the maximum 24-hour precipitation occurred.
     * @param {number} data.TotPcn - The total precipitation.
     * @param {number} data.Snow - The maximum snowfall.
     * @param {number} data["S Depth"] - The maximum snow depth.
     * @param {number} data.HDD - Heating Degree Days.
     * @param {number} data.CDD - Cooling Degree Days. (currently null/not calculated).
     * @param {object} data["NOD Pcn"] - Number of Days with Precipitation exceeding certain thresholds.
     * @param {number} data["NOD Pcn"].">.01" - Number of days with precipitation >= 0.01 units.
     * @param {number} data["NOD Pcn"].">.10" - Number of days with precipitation >= 0.10 units.
     * @param {number} data["NOD Pcn"].">1" - Number of days with precipitation >= 1.00 unit.
     * @param {object} data["NOD Tmp"] - Number of Days with Temperature exceeding certain thresholds.
     * @param {number} data["NOD Tmp"]."MxT>=90" - Number of days where maximum temperature was >= 90.
     * @param {number} data["NOD Tmp"]."MxT<=32" - Number of days where maximum temperature was <= 32.
     * @param {number} data["NOD Tmp"]."MnT<=0" - Number of days where minimum temperature was <= 0.
     * @param {number} data["SF>=1"] - Number of days with snowfall >= one inch
     * @param {number} data["SD>=1"] - Number of days with snow depth >= one inch 
     */
    function showGHCNDCalculations(data) {


        // Temperature
        $(".ghcnd-calc-av-max").text(data["AvMax"] !== null ? data["AvMax"]  : "N/A");
        $(".ghcnd-calc-av-min").text(data["AvMin"] !== null ? data["AvMin"]  : "N/A");
        $(".ghcnd-calc-av-temp").text(data["AvTmp"] !== null ? data["AvTmp"]  : "N/A");
        $(".ghcnd-calc-max-temp").text(data.MaxTp["MaxTp"] !== null ? data.MaxTp["MaxTp"]  : "N/A");
        $(".ghcnd-calc-max-temp-date").text(data.MaxTp["Day"] !== null ? data.MaxTp["Day"]  : "N/A");
        $(".ghcnd-calc-min-temp").text(data.MinTp["MinTp"]  !== null ? data.MinTp["MinTp"]  : "N/A");
        $(".ghcnd-calc-min-temp-date").text(data.MinTp["Day"] !== null ? data.MinTp["Day"] : "N/A" );

            // Precipitation and Snowfall
            $(".ghcnd-calc-totpcn").text(data["TotPcn"] !== null ? data["TotPcn"] : "N/A");
            $(".ghcnd-calc-snow").text(data["Snow"] !== null ? data["Snow"] : "N/A");
            $(".ghcnd-calc-snow-depth").text(data["S Depth"] !== null ? data["S Depth"] : "N/A");
            $(".ghcnd-calc-hdd").text(data["HDD"] !== null ? data["HDD"] : "N/A");
            $(".ghcnd-calc-cdd").text(data["CDD"] !== null ? data["CDD"] : "N/A"); 

        // Max 24-Hour Precipitation
        $(".ghcnd-calc-max-24hr").text(data.Max24Hr && data.Max24Hr["Max24Hr"] !== null ? data.Max24Hr["Max24Hr"] : "N/A");
        $(".ghcnd-calc-max-24hr-date").text(data.Max24Hr && data.Max24Hr["Day"] !== null ? data.Max24Hr["Day"] : "N/A");

        // Number of Days  Precipitation Thresholds
        $(".ghcnd-calc-pcn-gt01").text(data["NOD Pcn"] && data["NOD Pcn"][">.01"] !== null ? data["NOD Pcn"][">.01"] : "N/A");
        $(".ghcnd-calc-pcn-gt10").text(data["NOD Pcn"] && data["NOD Pcn"][">.10"] !== null ? data["NOD Pcn"][">.10"] : "N/A");
        $(".ghcnd-calc-pcn-gt100").text(data["NOD Pcn"] && data["NOD Pcn"][">1"] !== null ? data["NOD Pcn"][">1"] : "N/A");

        

        // Number of Days Temperature Thresholds
        $(".ghcnd-calc-max-temp-gt90").text(data["NOD Tmp"] && data["NOD Tmp"]["MxT>=90"] !== null ? data["NOD Tmp"]["MxT>=90"] : "N/A");
        $(".ghcnd-calc-max-temp-lt32").text(data["NOD Tmp"] && data["NOD Tmp"]["MxT<=32"] !== null ? data["NOD Tmp"]["MxT<=32"] : "N/A");
        $(".ghcnd-calc-min-temp-lt0").text(data["NOD Tmp"] && data["NOD Tmp"]["MnT<=0"] !== null ? data["NOD Tmp"]["MnT<=0"] : "N/A");
        
        // Number of Days with Snowfall >= one inch
        $(".ghcnd-calc-sf-gt100").text(data["SF>=1"] !== null ? data["SF>=1"] : "N/A");
        // Number of Days with Snow Depth >= one inch
        $(".ghcnd-calc-snow-depth-gt100").text(data["SD>=1"] !== null ? data["SD>=1"] : "N/A");

    }



    // **** Logic for saving the GHCN Table data to user's file System **** \\
    function downloadCSVFromJSON(jsonData, filename) {
        if (!jsonData || Object.keys(jsonData).length === 0) {
            errorPopup.warning("No data to export.");
            return;
        }

        // Extract all unique keys for CSV columns
        const allKeysSet = new Set();
        Object.values(jsonData).forEach(dayData => {
            Object.keys(dayData).forEach(key => allKeysSet.add(key));
        });
        const allKeys = Array.from(allKeysSet).sort();

        // Build CSV header
        let csv = "Day," + allKeys.join(",") + "\n";

        // Build CSV rows
            Object.keys(jsonData)
                .sort((a, b) => parseInt(a.replace('Day ', '')) - parseInt(b.replace('Day ', '')))
                .forEach(dayKey => {
                    const dayNumber = String(parseInt(dayKey.replace('Day ', ''))).padStart(2, '0');
                    const dayData = jsonData[dayKey];
                    let row = [dayNumber];
                    allKeys.forEach(key => {
                        let val = dayData[key] !== undefined ? dayData[key] : "";
                        if (typeof val === "string" && (val.includes(",") || val.includes('"'))) {
                            val = `"${val.replace(/"/g, '""')}"`;
                        }
                        row.push(val);
                    });
                    csv += row.join(",") + "\n";
                });

            // Trigger file download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

    // **** Get the station's metadata **** \\
    function fetchAndRenderStationMetadata(ghcnId) {
        if (!ghcnId) return;

        const container = document.getElementById("station-metadata-view");
        container.style.display = "none";
        container.innerHTML = "";

            // console.log("Hello 4");
            fetch(`/station_metadata?ghcn_id=${encodeURIComponent(ghcnId)}`)
                .then(response => {
                    if (!response.ok) throw new Error("Network response was not ok");
                    // console.log("Hello 5");
                    return response.text();
                })
                .then(html => {
                    container.innerHTML = html;
                    container.style.display = "block";
                    // If you use tooltips, initialize here, otherwise omit:
                    // $('[data-toggle="tooltip"]').tooltip();
                    // console.log("Hello 6");
                    $("#ghcnd-inventory-btn").on("click", function() {
                        getGhcnIdInventory(ghcnId);
                    });
                })
                .catch(err => {
                    console.error("Failed to load station metadata:", err);
                    // console.log("Hello 7");
                    return
                });
    }


    $(function() {
        // Handler for .ready() called.
        // alert("From the jquery again.");
        $('#GHCND-Inventory-Table').DataTable({
            columns: [
                {title: 'GHCNID', name: 'GHCNID'},
                {title: 'Latitude', name: 'Latitude'},
                {title: 'Longitude', name: 'Longitude'},
                {title: 'Element', name: 'Element'},
                {title: 'First Year', name: 'First Year'},
                {title: 'Last Year', name: 'Last Year'}

            ],
            columnDefs: [{ className: 'text-center', targets: '_all' }],

        });
    });


    function getGhcnIdInventory(ghcnId) {

        const requestData = {
                ghcn_id: ghcnId
            };
        console.log(ghcnId);
        $.ajax({
                url: '/ghcn_inventory',
                method: 'POST',
                data: $.param(requestData),
                success: function(response) {
                    console.log("Success:", response);
                    // console.log(response);

                    invTable = $('#GHCND-Inventory-Table').DataTable();
                    invTable.clear().rows.add(response).draw();
                    $("#station-inventory-view").show();
                },
                error: function(xhr, status, error) {
                    console.error("Error:", error, xkr, status);
                    handleAjaxError(xhr, status, error, "There was an error processing your data request.");
                }
            });

        

    }


    </script>
<!-- Date Picker Functionality -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const datePickerInput = document.getElementById('date');
        const monthList = document.getElementById('month-list');
        const yearList = document.getElementById('year-list');
        const okBtn = document.getElementById('ok-btn');
        
        const months = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];
        const currentYear = new Date().getFullYear();
        const years = Array.from({ length: 50 }, (_, i) => currentYear  - i);

        let selectedMonth = null;
        let selectedYear = null;

        function renderLists() {
            monthList.innerHTML = '';
            yearList.innerHTML = '';

            months.forEach((month, index) => {
                const monthElement = document.createElement('a');
                monthElement.href = "#";
                monthElement.textContent = month;
                monthElement.className = `list-group-item list-group-item-action text-center ${index === selectedMonth ? 'active' : ''}`;
                monthElement.addEventListener('click', (e) => {
                    e.preventDefault();
                    selectedMonth = index;
                    renderLists();
                });
                monthList.appendChild(monthElement);
            });

            years.forEach(year => {
                const yearElement = document.createElement('a');
                yearElement.href = "#";
                yearElement.textContent = year;
                yearElement.className = `list-group-item list-group-item-action text-center ${year === selectedYear ? 'active' : ''}`;
                yearElement.addEventListener('click', (e) => {
                    e.preventDefault();
                    selectedYear = year;
                    renderLists();
                });
                yearList.appendChild(yearElement);
            });
        }

        // Populate the list when the modal is shown
        const datePickerModal = document.getElementById('date-picker-modal');
        datePickerModal.addEventListener('show.bs.modal', function () {
            const now = new Date();
            selectedMonth = now.getMonth();
            selectedYear = now.getFullYear();
            renderLists();
        });

        okBtn.addEventListener('click', () => {
            if (selectedMonth !== null && selectedYear !== null) {
                const monthName = months[selectedMonth];
                datePickerInput.value = `${selectedYear}${monthName}`;
            }
        });
    });
</script>
{% endblock content %}

