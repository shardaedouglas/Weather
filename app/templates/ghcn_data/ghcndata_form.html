{% extends "base.html" %}
{% block title %}View GHCN Daily Data{% endblock %}
{% block content %}

<div class="container-md">
    <div class="row g-3">
        <div class="col g-3">
            <p style="font-size: 260%; font-weight: bold;">View Daily Data</p>
            <p>This is a brief description.</p>
        </div>
    </div>
 

<div class="container-md form-container" >
    <form class="row g-3 align-items-center">
        <div class="row g-3">
            <div class="col-md input-group">
                <input class="form-check-input id-option-ghcn" type="radio" id="radio-option-ghcn-id" name="id-option" value="GHCN ID" checked="checked" >
                <span class="input-group-text" id="inputGroup-sizing-default">GHCN ID</span> {{ghcnForm.ghcn_id(class_='form-control', id='search-option-ghcn-id')}}
            </div>
            
            <div class="col-md input-group" style="flex-wrap: nowrap;">
                <input class="form-check-input id-option-ghcn" type="radio" id="radio-option-country" name="id-option" value="Country">
                <span class="input-group-text" id="inputGroup-sizing-default">Country</span> 
                <span class="tt" title="Country Input">{{ghcnForm.country(class_='form-select country-select', id='search-option-country')}}</span>
            </div>
            
            <div class="col-md input-group" style="flex-wrap: nowrap;">
                <input class="form-check-input id-option-ghcn" type="radio" id="radio-option-state" name="id-option" value="State">
                <span class="input-group-text" id="inputGroup-sizing-small">State</span> {{ghcnForm.state(class_='form-select state-select', id='search-option-state')}}
            </div>
        </div>
        <div class="row g-3" style="padding-top: 15px; padding-bottom: 15px;">
            <div class="col-md input-group" style="flex-wrap: nowrap;">
                <span class="input-group-text" id="inputGroup-sizing-default">Type</span>
                {{ghcnForm.station_type(class_='form-select type-select')}}
            </div>
            <div class="col-md input-group" id="date-div">
                <span class="input-group-text" id="inputGroup-sizing-default" >Date</span>
                {{ghcnForm.date(class_='form-control date-picker')}}
            </div>
        </div>

        <div class="row justify-content-center" id="button-row">
            <div class="col-md">
                <button type="reset" class="btn button-dull" onclick="hideGHCNViewTable()" style="width:100%;display:block;font-weight: bold">Clear</button>
            </div>
            <div class="col-md">
                <button type="submit" class="btn btn-success" style="width:100%;display:block;font-weight: bold">Submit</button>
            </div>
            
        </div>
    </form>
</div>

<div id="spinner" class="spinner-border text-info" style="display:none; margin-left: auto; margin-right: auto; margin-top: 20px;" >
</div>

<div id="station-data-view" style="display:none;">
    {% include "ghcn_data/ghcn_station_data.html" %}
</div>

</div>  

<script>

    let lastFetchedData = null;

    
    document.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);
        console.log("urlParams", urlParams);
        if (urlParams.size > 0) {
            
            const loadingWheel = document.querySelector('#spinner');
            loadingWheel.style.display = 'block';

            let queryStringData = getDataFromURL(urlParams);
            document.getElementById("station-data-view").style.display = "block";

            loadingWheel.style.display = 'none';

        }        
    });
    
    function hideGHCNViewTable() {
       document.getElementById('station-data-view').style.display = "none";
    }

    $(document).ready(function() {

        // Disables other radio options when one is selected.
        function enableSelectedForm() {
            if ($("#radio-option-ghcn-id").is(":checked")) {
                $("#search-option-ghcn-id").removeAttr('disabled');
                $("#search-option-country").attr('disabled', true);
                $("#search-option-state").attr('disabled', true);


            } else if ($("#radio-option-country").is(":checked")) {
                $("#search-option-ghcn-id").attr('disabled', true);
                $("#search-option-country").removeAttr('disabled');
                $("#search-option-state").attr('disabled', true);


            } else if ($("#radio-option-state").is(":checked")) {
                $("#search-option-ghcn-id").attr('disabled', true);
                $("#search-option-country").attr('disabled', true);
                $("#search-option-state").removeAttr('disabled');


            }

        }
    
        // Initialize radio button disabling
        enableSelectedForm();
    
        // Handle radio button clicks to show the corresponding form
        $("input[name='id-option']").click(function() {
            enableSelectedForm();
        });
    })

    function downloadCSVFromJSON(jsonData, filename) {
        if (!jsonData || Object.keys(jsonData).length === 0) {
            alert("No data to export.");
            return;
        }

        // Extract all unique keys for CSV columns
        const allKeysSet = new Set();
        Object.values(jsonData).forEach(dayData => {
            Object.keys(dayData).forEach(key => allKeysSet.add(key));
        });
        const allKeys = Array.from(allKeysSet).sort();

        // Build CSV header
        let csv = "Day," + allKeys.join(",") + "\n";

        // Build CSV rows
            Object.keys(jsonData)
                .sort((a, b) => parseInt(a.replace('Day ', '')) - parseInt(b.replace('Day ', '')))
                .forEach(dayKey => {
                    const dayNumber = String(parseInt(dayKey.replace('Day ', ''))).padStart(2, '0');
                    const dayData = jsonData[dayKey];
                    let row = [dayNumber];
                    allKeys.forEach(key => {
                        let val = dayData[key] !== undefined ? dayData[key] : "";
                        if (typeof val === "string" && (val.includes(",") || val.includes('"'))) {
                            val = `"${val.replace(/"/g, '""')}"`;
                        }
                        row.push(val);
                    });
                    csv += row.join(",") + "\n";
                });

            // Trigger file download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

    //Form Submission and Show data table
    // $(document).ready(function () {
    //     $("form").submit(function (event) {
    //         event.preventDefault(); // Prevent the default form submission
    //         var formData = $(this).serialize(); //Retrieve the form data
    //         // Send the request to handle the form data. async?
    //         // Once data is returned, show the populated data table.
    //         showGHCNViewTable();
    //     })

    // });

    // function showComparisonTable(data) {
    //     const tableBody = document.querySelector("#station-data-view tbody");
    //     tableBody.innerHTML = ""; // Clear existing rows
    
    //     // Sort the days numerically
    //     const sortedDays = Object.keys(data).sort((a, b) => parseInt(a.replace('Day ', '')) - parseInt(b.replace('Day ', '')));

    //     sortedDays.forEach(dayKey => {
    //         const dayData = data[dayKey];
    //         const row = `
    //             <tr>
    //                 <td>${dayKey}</td>
    //                 <td>${dayData.TMAX || ""}</td>
    //                 <td>${dayData.TMIN || ""}</td>
    //                 <td>${dayData.TOBS || ""}</td>
    //                 <td>${dayData.PRCP || ""}</td>
    //                 <td>${dayData.SNOW || ""}</td>
    //                 <td>${dayData.SNWD || ""}</td>
    //                 <td>${dayData.WTXX || ""}</td>
    //             </tr>
    //         `;
    //         tableBody.insertAdjacentHTML('beforeend', row);
    //     });

    //     document.getElementById("station-data-view").style.display = "block";
    // }
    


//     function showComparisonTable(data) {
//         const table = document.getElementById("station-data-view");
//         const thead = table.querySelector("thead");
//         const tbody = table.querySelector("tbody");
//         tbody.innerHTML = ""; // clear old rows
//         thead.innerHTML = ""; // clear old headers
//         lastFetchedData = data;
//         selectedDisplayGroup = 1;
//         // Sort days numerically
//         const sortedDays = Object.keys(data).sort((a, b) => parseInt(a.replace('Day ', '')) - parseInt(b.replace('Day ', '')));

//         // Collect all unique keys from data (except day label)
//         const allKeysSet = new Set();
//         sortedDays.forEach(dayKey => {
//             Object.keys(data[dayKey]).forEach(k => allKeysSet.add(k));
//         });

//         // Convert to array and sort keys alphabetically or keep custom order
//         const allKeys = Array.from(allKeysSet).sort();

//         // Build table header row dynamically
//         let headerRow = `<tr><th>Day</th>`;
//         allKeys.forEach(key => {
//             headerRow += `<th>${key}</th>`;
//         });
//         headerRow += `</tr>`;
//         thead.insertAdjacentHTML('beforeend', headerRow);

//         // Build table rows dynamically
//         sortedDays.forEach(dayKey => {
//             const dayData = data[dayKey];
//             let row = `<tr><td>${dayKey}</td>`;
//             allKeys.forEach(key => {
//                 row += `<td>${dayData[key] !== undefined ? dayData[key] : ""}</td>`;
//             });
//             row += `</tr>`;
//             tbody.insertAdjacentHTML('beforeend', row);
//         });

//         table.style.display = "block";

//          // Attach save button event handler fresh to avoid duplicates
//         const saveBtn = document.getElementById("save-button");
//         if (saveBtn) {
//             // Remove previous listeners by cloning the node and replacing it
//             const newSaveBtn = saveBtn.cloneNode(true);
//             saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

//             newSaveBtn.addEventListener("click", function () {
//                 if (!lastFetchedData || lastFetchedData.length === 0) {
//                     alert("No data available to save.");
//                     return;
//                 }
//                 downloadCSVFromJSON(lastFetchedData, "GHCN_data_export.csv");
//             });
//         }

// }
    let selectedDisplayGroup = 1;


    function showComparisonTable(data, orderedKeys) {
        const table = document.getElementById("station-data-view");
        const thead = table.querySelector("thead");
        const tbody = table.querySelector("tbody");
        tbody.innerHTML = ""; // clear old rows
        thead.innerHTML = ""; // clear old headers
        lastFetchedData = data;

        // Sort days numerically
        const sortedDays = Object.keys(data).sort(
            (a, b) => parseInt(a.replace('Day ', '')) - parseInt(b.replace('Day ', ''))
        );

        // Use orderedKeys from backend or fallback to keys from data
        const allKeys = orderedKeys && orderedKeys.length > 0
            ? orderedKeys
            : (() => {
                const keysSet = new Set();
                sortedDays.forEach(dayKey => {
                    Object.keys(data[dayKey]).forEach(k => keysSet.add(k));
                });
                return Array.from(keysSet).sort();
            })();

        // Build table header row dynamically
        let headerRow = `<tr><th>Day</th>`;
        allKeys.forEach(key => {
            if (key !== "Day") headerRow += `<th>${key}</th>`;
        });
        headerRow += `</tr>`;
        thead.insertAdjacentHTML('beforeend', headerRow);

        // Build table rows dynamically
        sortedDays.forEach(dayKey => {
            const dayData = data[dayKey];
            let row = `<tr><td>${dayKey}</td>`;
            allKeys.forEach(key => {
                if (key !== "Day") {
                    row += `<td>${dayData[key] !== undefined ? dayData[key] : ""}</td>`;
                }
            });
            row += `</tr>`;
            tbody.insertAdjacentHTML('beforeend', row);
        });

        table.style.display = "block";

        // Attach save button event handler fresh to avoid duplicates
        const saveBtn = document.getElementById("save-button");
        if (saveBtn) {
            const newSaveBtn = saveBtn.cloneNode(true);
            saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

            newSaveBtn.addEventListener("click", function () {
                if (!lastFetchedData || Object.keys(lastFetchedData).length === 0) {
                    alert("No data available to save.");
                    return;
                }
                downloadCSVFromJSON(lastFetchedData, "GHCN_data_export.csv");
            });
        }
    }


        function populateYearDropdown(response) {
            const yearDropdown = document.getElementById("year-selector");
            yearDropdown.innerHTML = '<option selected>--Select--</option>';

            if (response.years && Array.isArray(response.years)) {
                response.years.forEach(yr => {
                    const opt = document.createElement("option");
                    opt.value = yr;
                    opt.textContent = yr;
                    yearDropdown.appendChild(opt);
                });
            } else {
                const placeholderYears = [2021, 2022, 2023];
                placeholderYears.forEach(yr => {
                    const opt = document.createElement("option");
                    opt.value = yr;
                    opt.textContent = yr;
                    yearDropdown.appendChild(opt);
                });
            }
        }
        

        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("year-selector").addEventListener("change", function () {
                const selectedYear = this.value;
                if (selectedYear && selectedYear !== "--Select--") {
                    const ghcnId = new URLSearchParams(window.location.search).get("ghcn_id");
                    const stationType = new URLSearchParams(window.location.search).get("station_type");
                    
                    // Fake a correction_date using just year + dummy month/day
                    const correctionDate = `${selectedYear}-01-01`;

                    $.ajax({
                        url: '/get_data_for_GHCN_table',
                        method: 'POST',
                        data: $.param({
                            ghcn_id: ghcnId,
                            date: correctionDate,
                            station_type: stationType
                        }),
                        success: function (response) {
                            console.log("RESPONSE.DATA = ", response.data)
                            lastFetchedData = response.data;
                            console.log("lastFetchedData = ", lastFetchedData)
                            console.log("response keys 1:", Object.keys(response));
                            console.log("orderedKeys 1:", response.orderedKeys);
                            showComparisonTable(response.data, response.ordered_keys);
                        },
                        error: function (xhr, status, error) {
                            console.error("Error reloading year:", error);
                            alert("Could not load data for selected year.");
                        }
                    });
                }
            });
            
        });

        document.addEventListener("DOMContentLoaded", function () {
            const unitSelector = document.getElementById("unit-selector");
            
            unitSelector.addEventListener("change", function () {
                const unitMode = this.value;
                const urlParams = new URLSearchParams(window.location.search);
                const ghcnId = urlParams.get("ghcn_id");
                const stationType = urlParams.get("station_type");
                const date = urlParams.get("date");

                console.log("unitMode:", unitMode);
                console.log("ghcn_id from URL:", ghcnId);
                console.log("station_type from URL:", stationType);
                console.log("date from URL:", date);


                if (ghcnId && stationType && date && unitMode) {
                    $.ajax({
                        url: '/get_data_for_GHCN_table',
                        method: 'POST',
                        data: $.param({
                            ghcn_id: ghcnId,
                            date: date,
                            station_type: stationType,
                            unit_mode: unitMode,
                            display_group: selectedDisplayGroup
                        }),
                        success: function (response) {
                            console.log("RESPONSE.DATA = ", response.data)

                            lastFetchedData = response.data;
                            console.log("lastFetchedData = ", lastFetchedData)
                            console.log("response keys 2:", Object.keys(response));
                            console.log("orderedKeys 2:", response.orderedKeys);
                            showComparisonTable(response.data, response.ordered_keys);

                        },
                        error: function (xhr, status, error) {
                            console.error("Unit change error:", error);
                            alert("Failed to reload data with selected units.");
                        }
                    });
                }
            });
        });


        document.addEventListener("DOMContentLoaded", function () {
            const displaySelector = document.getElementById("display-selector");

            displaySelector.addEventListener("change", function () {
                selectedDisplayGroup = this.value;
                const urlParams = new URLSearchParams(window.location.search);
                const ghcnId = urlParams.get("ghcn_id");
                const stationType = urlParams.get("station_type");
                const date = urlParams.get("date");
                const unitMode = document.getElementById("unit-selector").value;
                console.log("selectedDisplayGroup:", selectedDisplayGroup);

                
                if (ghcnId && stationType && date && selectedDisplayGroup) {
                    $.ajax({
                        url: '/get_data_for_GHCN_table',
                        method: 'POST',
                        data: $.param({
                            ghcn_id: ghcnId,
                            date: date,
                            station_type: stationType,
                            unit_mode: unitMode,
                            display_group: selectedDisplayGroup
                        }),
                        success: function (response) {
                            console.log("RESPONSE.DATA = ", response.data)
                            lastFetchedData = response.data;
                            console.log("lastFetchedData = ", lastFetchedData)
                            console.log("response keys 3 :", Object.keys(response));
                            console.log("orderedKeys 3:", response.orderedKeys);
                            showComparisonTable(response.data, response.ordered_keys);
                        },
                        error: function (xhr, status, error) {
                            console.error("Display group change error:", error);
                            alert("Failed to reload data with selected display group.");
                        }
                    });
                }
            });
        });


        function getDataFromURL(urlParams) {
            const idOption = urlParams.get('id-option');

            const stationType = urlParams.get('station_type');
            const date = urlParams.get('date');

            if (idOption === 'State') {
                const state = urlParams.get('state');

                const requestData = {
                    state: state,
                    date: date,
                    station_type: stationType,
                };

                $.ajax({
                    url: '/get_state_for_GHCN_table_df',
                    method: 'POST',
                    data: $.param(requestData),
                    success: function(response) {
                        console.log("RESPONSE.DATA = ", response.data)
                        lastFetchedData = response.data;
                        console.log("lastFetchedData = ", lastFetchedData)
                        console.log("response keys 4:", Object.keys(response));
                        console.log("orderedKeys 4:", response.orderedKeys);
                        showComparisonTable(response, response.ordered_keys);
                        populateYearDropdown(response);
                    },
                    error: function(xhr, status, error) {
                        console.error("Error:", error);
                        alert("There was an error processing your request.");
                    }
                });

            } else {
                const ghcnId = urlParams.get('ghcn_id');
                const unitMode = document.getElementById("unit-selector").value;

                const requestData = {
                    ghcn_id: ghcnId,
                    date: date,
                    station_type: stationType,
                    unit_mode: unitMode,
                    display_group: selectedDisplayGroup || 1

                };

                $.ajax({
                    url: '/get_data_for_GHCN_table',
                    method: 'POST',
                    data: $.param(requestData),
                    success: function(response) {

                        console.log("RESPONSE.DATA = ", response.data)                       
                        lastFetchedData = response.data;
                        console.log("lastFetchedData = ", lastFetchedData)    
                        console.log("response keys 5:", Object.keys(response));
                        console.log("orderedKeys 5:", response.orderedKeys);                   
                        showComparisonTable(response.data, response.ordered_keys);
                        populateYearDropdown(response);
                    },
                    error: function(xhr, status, error) {
                        console.error("Error:", error);
                        alert("There was an error processing your request.");
                    }
                });
            }
        }


    </script>

{% endblock content %}