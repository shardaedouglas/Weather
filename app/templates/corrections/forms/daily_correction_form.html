{% extends "base.html" %}
{% block title %}Daily Correction{% endblock %}
{% block content %}
<!--Daily Form-->

<div class="container-md justify-content-center" id="form-daily">
    <div class="container-md">
        <div class="row g-3">
            <div class="col g-3">
                <h1>Enter a Daily Correction</h1>
                <p>This is a brief description of Daily Corrections.</p>
            </div>
        </div>
    </div>
    <div class="container-md form-container">
    <form class="row g-3 align-items-center ">
        <div class="row g-3 justify-content-center">
            <div class="col-lg-4">

                <div class="input-group">
                    <span class="input-group-text" id="inputGroup-sizing-default" style="font-weight: bold" >GHCN ID <span class="text-danger">*</span></span>
                    {{daily_form.ghcn_id(class_='form-control')}}
                </div>
            </div>
            <div class="col-lg-3 col-md-5 col-6 justify-content-start" id="date-div">
                <div class="input-group">
                    <span class="input-group-text" id="inputGroup-sizing-default" style="font-weight: bold">Date <span class="text-danger">*</span></span>
                    {{daily_form.date(class_='form-control date-picker')}}
                </div>
            </div>
            <div class="col-lg-3 col-md-6" style="flex-wrap: nowrap;">
                <div class="input-group">
                    <span class="input-group-text" id="inputGroup-sizing-default" style="font-weight: bold">Datzilla #</span>
                    {{daily_form.datzilla_number(class_='form-control')}}
                </div>
            </div>
        </div>
        <div class="row g-3 justify-content-center" >
            <div class="col-lg-3 col-md-4 col-sm-5" style=" flex-wrap: nowrap; max-height: 40px">
                <div class="input-group">
                    <span class="input-group-text" id="inputGroup-sizing-default" style="font-weight: bold;">Action <span class="text-danger">*</span></span>
                    {{daily_form.action(class_='form-control')}}
                </div>
            </div>
            <div class="col-lg-3 col-md-5 col-sm-5 col-6 justify-content-start" style="flex-wrap: nowrap;">
                <div class="input-group">
                    <span class="input-group-text element-select" id="inputGroup-sizing-default" style="font-weight: bold">Element <span class="text-danger">*</span></span>
                    {{daily_form.element(class_='form-select element-select')}}
                </div>
            </div>
            <!-- Sub selection for Element -->
            <div class=" col-lg-4 col-md-5 col-6 justify-content-start d-none" style="flex-wrap: nowrap;" id="sub-element-select">
                <div class="input-group">
                    <span class="input-group-text element-select" id="inputGroup-sizing-default" style="font-weight: bold">Sub-Element</span>
                    <div class="col sub-element-option">{{daily_form.sub_element_SN(class_='form-select element-select')}}</div>
                    <div class="col sub-element-option">{{daily_form.sub_element_SX(class_='form-select element-select')}}</div>
                    <div class="col sub-element-option">{{daily_form.sub_element_WT(class_='form-select element-select')}}</div>
                    <div class="col sub-element-option">{{daily_form.sub_element_WV(class_='form-select element-select')}}</div>
                </div>
            </div>
            

        </div>
        <div class="row g-3 justify-content-center">
                    <div class="col col-md-4 col-lg-3" style=" flex-wrap: nowrap;">
                        <div class="input-group">
                            <span class="input-group-text" id="inputGroup-sizing-default" style="font-weight: bold">O-Value</span>
                            {{daily_form.o_value(class_='form-control')}}
                        </div>
                    </div>

            <div class="col col-md-4 col-lg-3" style=" flex-wrap: nowrap;  max-height: 40px">
                <div class="input-group">
                    <span class="input-group-text" id="inputGroup-sizing-default" style="font-weight: bold;">E-Value</span>
                    {{daily_form.e_value(class_='form-control')}}
                </div>
            </div>
            <div class="col-lg-2 col-md-3" style="flex-wrap: nowrap;">
                <div class="input-group">
                    <span class="input-group-text" id="inputGroup-sizing-default" style="font-weight: bold">E Flag</span>
                    {{daily_form.eflag(class_='form-control')}}
                </div>
            </div>
            <div class="w-100 d-block d-md-none"></div>
            <div class="col-5 col-md-3 col-xl-2" style=" flex-wrap: nowrap;">

                <div class="input-group">
                    <span class="input-group-text" id="inputGroup-sizing-default" style="font-weight: bold;">Source</span>
                    {{daily_form.source(class_='form-control')}}
                </div>
            </div>

            
            
        </div>
        <div class="row pb-3 g-3 border justify-content-center align-items-center" >
            <div class="col-3 col-md-2 col-xxl-2 text-start" style=" flex-wrap: nowrap;">
                
                <span class="fw-bold">M Flag:</span> 
                <span id="m-flag-output"></span>
            </div>
            <div class="col-3 col-md-2 col-xxl-2 text-start" style=" flex-wrap: nowrap;">

                <span class="fw-bold">Q Flag:</span> 
                <span id="q-flag-output"></span>
                
            </div>
            <div class="col-3 col-md-2 col-xxl-2 text-start" style=" flex-wrap: nowrap;">

                <span class="fw-bold">S Flag:</span> 
                <span id="s-flag-output"></span>
                
            </div>
            
        </div>
        
        <div class="row g-3" >
            <div class="col-sm">
                <button type="submit" class="btn button-light" style="width:100%;display:block;font-weight: bold;" id="compare-daily-btn">Compare</button>
            </div>
            
            <div class="col-sm">

                {{daily_form.submit(class_='btn btn-success btn-submit', id='submit-daily-corr-btn', style='width:100%;display:block;')}}

            </div>

        </div>
        <div class="row g-3" >
            <div class="col-sm">
                <button type="reset" class="btn button-dull" style="width:100%;display:block;font-weight: bold" id="daily-clear-btn">Clear</button>
            </div>
        </div>
    </form>
</div>

    
    <div id="spinner" class="spinner-border text-info" style="display:none; margin-left: auto; margin-right: auto; margin-top: 20px;" >
    </div>

<style>
/* Comparison Table Dark Mode Styling */
#correction-comparison-table {
    background-color: #ffffff;
    color: #212529;
}

#correction-comparison-table th {
    background-color: #f8f9fa;
    color: #495057;
    border-color: #dee2e6;
    font-weight: 600;
}

#correction-comparison-table td {
    background-color: #ffffff;
    color: #212529;
    border-color: #dee2e6;
}

#correction-comparison-table tbody tr:hover {
    background-color: #f8f9fa;
}

#correction-comparison-table tbody tr:nth-child(odd) {
    background-color: #ffffff;
}

#correction-comparison-table tbody tr:nth-child(even) {
    background-color: #f8f9fa;
}

/* Dark mode adjustments for comparison table */
.dark-mode #correction-comparison-table {
    background-color: #2d3748;
    color: #e2e8f0;
}

.dark-mode #correction-comparison-table th {
    background-color: #4a5568;
    color: #e2e8f0;
    border-color: #718096;
}

.dark-mode #correction-comparison-table td {
    background-color: #2d3748;
    color: #e2e8f0;
    border-color: #4a5568;
}

.dark-mode #correction-comparison-table tbody tr:hover {
    background-color: #4a5568 !important;
}

.dark-mode #correction-comparison-table tbody tr:nth-child(odd) {
    background-color: #2d3748;
}

.dark-mode #correction-comparison-table tbody tr:nth-child(even) {
    background-color: #374151;
}

/* High contrast mode adjustments */
.high-contrast #correction-comparison-table {
    border: 2px solid #000000 !important;
}

.high-contrast #correction-comparison-table th,
.high-contrast #correction-comparison-table td {
    border: 1px solid #000000 !important;
}

.dark-mode.high-contrast #correction-comparison-table {
    border: 2px solid #ffffff !important;
}

.dark-mode.high-contrast #correction-comparison-table th,
.dark-mode.high-contrast #correction-comparison-table td {
    border: 1px solid #ffffff !important;
}
</style>

    <div class="row" style="text-align: center">
        <div class="col">
            <div id="correction-comparison-table" style="display:none;">
                {% include "corrections/data_tables/correction_comparison_table.html" %}
            </div>
        </div>
    </div>
</div>
<div id="submission-element" style="display: none;">
    {% include "corrections/correction_submitted_element.html" %}
</div>

<script>
        $(document).ready(function () {

            // Clear button functionality
            $("#daily-clear-btn").click(function() {
                // Hide the comparison table when clear is pressed
                document.getElementById('correction-comparison-table').style.display = "none";
            });

            $("form").submit(function (event) {
                event.preventDefault();

                // Loading Wheel
                const loadingWheel = document.querySelector('#spinner');
                loadingWheel.style.display = 'block';

                formData = formatWeatherDataQuery($(this));
                console.log($(this));

                const params = new URLSearchParams(formData);
                console.log("Params: ", params);

                var clickedButton = event.originalEvent.submitter;
                
                if (typeof clickedButton !== 'undefined') {
                    if (clickedButton.id === 'compare-daily-btn') {
                        getDataforStationsAndShowTable(params);
                    } else if (clickedButton.id === 'submit-daily-corr-btn' ) {
                        submitCorrections(formData); // Call the submit function separately
                        // If showing the submission page goes, here, it MUST trigger AFTER the ajax from submitCorrections() runs. 
                    }
                } else {
                    console.log("No button used to submit daily correction");
                    document.querySelector("form").requestSubmit(document.querySelector("form").querySelector("#submit-daily-corr-btn"));
                }

            });

            $("form").on('keypress', function(event) {
                // Check if the pressed key is Enter (keyCode 13)
                if (event.keyCode === 13) {
                    event.preventDefault(); // Prevent the default form submission
                    document.querySelector("form").requestSubmit(document.querySelector("form").querySelector("#submit-daily-corr-btn"));
                }
            });

        });


        document.addEventListener('DOMContentLoaded', function() {
            // Select the form fields
            const ghcnIdInput = document.querySelector('input[name="ghcn_id"]');
            const dateInput = document.querySelector('input[name="date"]');
            const elementSelect = document.querySelector('select[name="element"]');
            const oValueInput = document.querySelector('[name="o_value"]');  // Correctly target O-Value input field
            

           

            // Function to check if all fields have values
            function checkFields() {
                if (ghcnIdInput.value && dateInput.value && elementSelect.value) {
                    final_element = ""

                    // Replace ELEMENT subselection if relevant.
                    console.log(elementSelect.value.toString());
                    switch (elementSelect.value.toString()) {
                        case "SN*#": {
                            final_element = $("#sub_element_SN").val().toString();
                            break;
                        }
                        case "SX*#": {
                            final_element = $("#sub_element_SX").val().toString();
                            break;
                        }
                        case "WT**": {
                            final_element = $("#sub_element_WT").val().toString();
                            break;
                        }
                        case "WV**": {
                            final_element = $("#sub_element_WV").val().toString();
                            break;
                        }
                        default: {
                            final_element = elementSelect.value;
                        }

                    }
                // Prepare the request data
                const requestData = {
                    ghcn_id: ghcnIdInput.value,
                    correction_date: dateInput.value,
                    element: final_element
                };


                // Send the data via AJAX to the /get_o_value route
                $.ajax({
                    url: '/get_o_value', 
                    method: 'POST',
                    data: $.param(requestData),
                    success: function(response) {
                        // Handle the response here, e.g., show comparison table
                        console.log("Success:", response.o_value, response.o_flag_value);
                        // Check if O-Value exists in the response
                        if (response.o_value) {
                            oValueInput.value = response.o_value; // Populate the O-Value field
                            $("#m-flag-output").text(response.o_flag_value.charAt(0));
                            $("#q-flag-output").text(response.o_flag_value.charAt(1));
                            $("#s-flag-output").text(response.o_flag_value.charAt(2));
                        } else {
                            errorPopup.warning("O-Value not found.");
                        }
                    },
                    
                    error: function(xhr, status, error) {
                        console.error("Error:", error);
                        handleAjaxError(xhr, status, error, "There was an error retrieving the O-Value.");
                    }
                });
            }
        }
            // Add event listeners to the fields
            ghcnIdInput.addEventListener('input', checkFields);
            dateInput.addEventListener('input', checkFields);
            elementSelect.addEventListener('change', checkFields);
            $(".sub-element-option").on('change', checkFields);
        });

        // Showing sub elements for element selection
        $("#element").on("change", function() {
            switch ($("#element").val().toString()) {
                case "SN*#":
                $("#sub-element-select").removeClass("d-none");
                $(".sub-element-option").addClass("d-none");
                $("#sub_element_SN").parent().removeClass("d-none");
                break;
                case "SX*#":
                $("#sub-element-select").removeClass("d-none");
                $(".sub-element-option").addClass("d-none");
                $("#sub_element_SX").parent().removeClass("d-none");
                break;
                case "WT**":
                $("#sub-element-select").removeClass("d-none");
                $(".sub-element-option").addClass("d-none");
                $("#sub_element_WT").parent().removeClass("d-none");
                break;
                case "WV**":
                $("#sub-element-select").removeClass("d-none");
                $(".sub-element-option").addClass("d-none");
                $("#sub_element_WV").parent().removeClass("d-none");
                break;
                

                default:
                    // console.log("Selected " + $("#element").val().toString() );
                    // sub-element-select
                    $("#sub-element-select").addClass("d-none");
            }
        });



     /** 
      * DAILY Comparison table Logic:
      * The logic below handles showing the GHCN data for neighboring weather station 
      * **/
     function showDailyComparisonTable(filteredData) {
        
        const tableBody = document.querySelector('#correction-comparison-table tbody');
        
        // Clear existing rows in the table
        tableBody.innerHTML = '';
                
        
        // Check if the returnData array is not empty
    if (filteredData && filteredData.returnData && filteredData.returnData.length > 0) {
        //console.log("Data:", filteredData);

        filteredData.returnData.forEach(item => {
                    const newRow = `
                        <tr>
                            <td class="ghcn-table-cell">${item.distance} mi</td>
                            <td class="ghcn-table-cell">${item.elevation} ft</td>
                            <td class="ghcn-table-cell">${item.station_code}</td>
                            <td class="ghcn-table-cell">${item.dayMinus}</td>
                            <td class="ghcn-table-cell">${item.day}</td>
                            <td class="ghcn-table-cell">${item.dayPlus}</td>
                        </tr>
                    `;
                    tableBody.insertAdjacentHTML('beforeend', newRow);
                });
            }

    // Show the Neighboring Station Comaprison table
    document.getElementById('correction-comparison-table').style.display = "block";
}


    function getDataforStationsAndShowTable(urlParams) {
        
        // Extract the query parameters
        const ghcnId = urlParams.get('ghcn_id');
        const datzillaNumber = urlParams.get('datzilla_number');
        const element = urlParams.get('element');
        const action = urlParams.get('action');
        const oValue = urlParams.get('o_value');
        const eValue = urlParams.get('e_value');
        const date = urlParams.get('date');

        var requestData = {
            ghcn_id: ghcnId,
            datzilla_number: datzillaNumber,
            element: element,
            action: action,
            o_value: oValue,
            e_value: eValue,
            date: date,
            correction_type: "compare"
        };

        console.log("!DATA: ", requestData);

        // Send the data via AJAX
        $.ajax({
            url: '/get_data_for_daily_corrections', 
            method: 'POST',
            data: $.param(requestData),
            success: function(response) {
                //console.log("Success:", response);
                
                // Handle processing
                showDailyComparisonTable(response);
                
            },
            error: function(xhr, status, error) {
                console.error("Error:", error);
                handleAjaxError(xhr, status, error, "There was an error processing your correction request.");
            }
        });
        }
    

        

    //DAILY Comparison table
    function showDailyComparisonTable(filteredData) {
        
        const tableBody = document.querySelector('#correction-comparison-table tbody');
        const loadingWheel = document.querySelector('#spinner');
        
        // Clear existing rows in the table
        tableBody.innerHTML = '';
        loadingWheel.style.display = 'none';

                
        
        // Check if the returnData array is not empty
    if (filteredData && filteredData.returnData && filteredData.returnData.length > 0) {
        //console.log("Data:", filteredData);

        filteredData.returnData.forEach(item => {
                    const newRow = `
                        <tr>
                            <td class="ghcn-table-cell">${item.distance} mi</td>
                            <td class="ghcn-table-cell">${item.elevation} ft</td>
                            <td class="ghcn-table-cell">${item.station_code}</td>
                            <td class="ghcn-table-cell">${item.dayMinus}</td>
                            <td class="ghcn-table-cell">${item.day}</td>
                            <td class="ghcn-table-cell">${item.dayPlus}</td>
                        </tr>
                    `;
                    tableBody.insertAdjacentHTML('beforeend', newRow);
                });
            }

    // Show the table
    document.getElementById('correction-comparison-table').style.display = "block";
}


    //DAILY Comparison TABLE
    function showComparisonTable(filteredData) {
        const tableBody = document.querySelector('#correction-comparison-table tbody');
        
        // Clear existing rows in the table
        tableBody.innerHTML = '';
                
        
        //Add to table data.
        if (filteredData) {
            //console.log("Data:", filteredData);
    
            const newRow = `
                <tr>
                    <td class="ghcn-table-cell">Dist</td>
                    <td class="ghcn-table-cell">Elev</td>
                    <td class="ghcn-table-cell">${filteredData.station_code}</td>
                    <td class="ghcn-table-cell">${filteredData.dayMinus}</td>
                    <td class="ghcn-table-cell">${filteredData.day}</td>
                    <td class="ghcn-table-cell">${filteredData.dayPlus}</td>
                </tr>
            `;
            tableBody.insertAdjacentHTML('beforeend', newRow);
        }

        // Show the table
        document.getElementById('correction-comparison-table').style.display = "block";
    }


    /**
     * Submits daily correction data to the backend.
     *
     * This function handles the submission of correction data collected from the daily correction form.
     * It will alert an error if the submission process fails.
     *
     * @param {object} correctionData - An object containing the daily correction data to be submitted.
     */
    function submitCorrections(correctionData) {
        console.log("Submitting correction data:", JSON.stringify(correctionData));
    
        // Send the data via AJAX
        $.ajax({
            url: '/submit_daily_corrections',
            method: 'POST',
            contentType: 'application/json', // Set content type to JSON
            data: JSON.stringify({ correction_data: correctionData }), // Convert array to JSON string
            success: function(response) {
                // Handle processing
                handleAjaxSuccess("Corrections Submitted Successfully");
                // Return true?
                // If correction was successful, show the submission confirmation screen. 
                showSubmissionConfirmation("daily");
            },
            error: function(xhr, status, error) {
                console.error("Error:", error);
                handleAjaxError(xhr, status, error, "There was an error processing your correction request.");
                // Return false?
                // FOR TESTING 
                showSubmissionConfirmation("daily");
            }
        });


    }
</script>

{% endblock content %}